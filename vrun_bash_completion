# Fonction de notre auto completion

contain(){
  local i
  for i in $2; do
      if [[ "$i" = "$1" ]]; then
        return 0
      fi
  done
  return 1
}


_vrun(){
  # declaration des variables locales
  local argc first cur opts files onoff playlist_opts help track

  #COMPREPLY désigne la réponse à renvoyer pour la complétion actuelle
  COMPREPLY=()

  # argc : vaut le nombre d'argument actuel sur la ligne de commande
  argc=${COMP_CWORD};

  # cur  : désigne la chaine de caractère actuelle pour le dernier mot de la ligne de commande
  first="${COMP_WORDS[1]}"
  cur="${COMP_WORDS[argc]}"
  opts="`vrun help \"\\*\" | sed 's/\. \. .*//;s/, /\n/g;/^+/d;s/| *//g;s/ .*//;s/\r//g'` start"
  files="add enqueue start"
  onoff="repeat loop random fullscreen f"
  playlist_opts="playlist goto delete"
  help="help ?"
  track="atrack vtrack vratio vcrop crop vzoom zoom vdeinterlace vdeinterlace_mode vdeinterlace_mode"

  # les options possibles pour notre auto-complétion
  if [ $argc -eq 1 ]; then
    # on auto-complete la ligne de commande en recherchant cur dans la liste opts.
    #A noter que le -- est important ici pour éviter les "injections d'options" depuis $cur.
    COMPREPLY=( $(compgen -W "$opts" -- $cur ) )
    return 0
  fi
  if [ $argc -eq 2 ]; then
    if contain $first  "$onoff"; then
      COMPREPLY=( $(compgen -W "on off" -- $cur) )
      return 0
    fi
    if contain $first "$help" ]]; then
	COMPREPLY=( $(compgen -W "$opts" -- $cur ) )
	return 0
    fi
    if contain $first "$track"; then
      COMPREPLY=( $(compgen -W "`vrun $first |
        sed \"s/^\+.*//;
        s/| *//;
	s/\((\|\[\).*//;
	s/\( *\)$//;
	#s/ /_/g;
        s/ / /g; #on remplace les espace par un espace insécable dans le sed
        s/\r//g;
	s/'/\\\\\\\\'/;
	\"`" -- $cur ) )
    fi;
  fi
  if [ $argc -le 3 ]; then
    if [[ $first = "move" ]] || ([ $argc -eq 2 ] && contain $first "$playlist_opts"); then
      COMPREPLY=( $(compgen -W "`vrun playlist 2 |
        sed \"s/^\+.*//;
        s/| *//;
	s/\((\|\[\).*//;
	s/\( *\)$//;
	#s/ /_/g;
        s/ / /g; #on remplace les espace par un espace insécable dans le sed
        s/\r//g;
	s/'/\\\\\\\\'/;
	\"`" -- $cur ) )
      return 0
    fi
  fi
  if contain $first "$files"; then
    _filedir &>/dev/null
    return 0
  fi

}

# On active l'auto-completion de la commande vrun en relation avec la fonction _vrun
complete -F _vrun vrun
