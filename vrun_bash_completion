# Fonction de notre auto completion

contain(){
  local i
  for i in $2; do
      if [[ "$i" = "$1" ]]; then
        return 0
      fi
  done
  return 1
}


_vrun(){
  # declaration des variables locales
  local argc first cur opts files onoff playlist_opts

  #COMPREPLY désigne la réponse à renvoyer pour la complétion actuelle
  COMPREPLY=()

  # argc : vaut le nombre d'argument actuel sur la ligne de commande
  argc=${COMP_CWORD};

  # cur  : désigne la chaine de caractère actuelle pour le dernier mot de la ligne de commande
  first="${COMP_WORDS[1]}"
  cur="${COMP_WORDS[argc]}"
  opts="achan add adev atrack chapter chapter_n chapter_p clear description enqueue faster fastforward frame fullscreen get_length get_time get_title goto help info is_playing lock logout longhelp loop next normal pause play playlist prev quit random rate repeat rewind sd search seek shutdown slower snapshot sort stats status stop strack title title_n title_p vcrop vdeinterlace vdeinterlace_mode vlm voldown volume volup vratio vtrack vzoom"

  files="add enqueue"
  onoff="repeat loop random fullscreen f"
  playlist_opts="playlist goto"

  # les options possibles pour notre auto-complétion
  if [ $argc -eq 1 ]; then
    # on auto-complete la ligne de commande en recherchant cur dans la liste opts.
    #A noter que le -- est important ici pour éviter les "injections d'options" depuis $cur.
    COMPREPLY=( $(compgen -W "$opts" -- $cur ) )
    return 0
  fi
  if [ $argc -eq 2 ]; then
    if contain $first  "$onoff"; then
      COMPREPLY=( $(compgen -W "on off" -- $cur) )
      return 0
    fi
    if contain $first "$playlist_opts" ]]; then
      COMPREPLY=( $(compgen -W "`vrun playlist 2 |
        sed '/^\+/d;
        s/| *//;
        s/ / /g; #on remplace les espace par un espace insécable dans le sed
        s/\r//;
        s/\((\|\[\).*//'`" -- $cur ) )
      return 0
    fi
  fi
  if contain $first "$files"; then
    _filedir &>/dev/null
    return 0
  fi

}

# On active l'auto-completion de la commande vrun en relation avec la fonction _vrun
complete -F _vrun vrun
